import { useAuth } from '../contexts/AuthContext';
import { useNavigate } from 'react-router-dom';
import { useEffect, useState } from 'react';
import { supabase } from '../lib/supabase';
import { CHARACTER_CLASSES } from '../data/characterClasses';

interface Character {
  id: strin                    <button 
                      onClick={() => navigate('/missions')}
                      className="neon-button w-full text-left text-sm"
                    >
                      üìã MISSIONS
                    </button>
                    <button 
                      onClick={() => navigate('/encounter')}
                      className="neon-button w-full text-left text-sm"
                      style={{ borderColor: 'var(--color-cyber-pink)', color: 'var(--color-cyber-pink)' }}
                    >
                      ‚öîÔ∏è ENCOUNTER
                    </button>
                  </div>layer_id: string;
  name: string;
  class: string;
  level: number;
  current_hp: number;
  max_hp: number;
  ac: number;
  cdd: string;
  str: number;
  dex: number;
  con: number;
  wis: number;
  int: number;
  cha: number;
  usd: number;
  save_proficiencies: string[];
  tools: string[];
  class_features: any[];
}

export default function PlayerDashboard() {
  const { user, profile, signOut } = useAuth();
  const navigate = useNavigate();
  const [characters, setCharacters] = useState<Character[]>([]);
  const [selectedCharacter, setSelectedCharacter] = useState<Character | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => {
    if (user) {
      fetchCharacters();
    }
  }, [user]);

  const fetchCharacters = async () => {
    try {
      setLoading(true);
      const { data, error: fetchError } = await supabase
        .from('characters')
        .select('*')
        .eq('user_id', user?.id)
        .order('created_at', { ascending: false });

      if (fetchError) throw fetchError;

      setCharacters(data || []);
      if (data && data.length > 0) {
        setSelectedCharacter(data[0]); // Auto-select first character
      }
    } catch (err: any) {
      console.error('Error fetching characters:', err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  const handleSignOut = async () => {
    await signOut();
    navigate('/login');
  };

  const getClassInfo = (classId: string) => {
    return CHARACTER_CLASSES.find(c => c.id === classId);
  };

  const calculateStatModifier = (stat: number) => {
    return Math.floor((stat - 10) / 2);
  };

  const formatModifier = (modifier: number) => {
    return modifier >= 0 ? `+${modifier}` : `${modifier}`;
  };

  return (
    <div className="min-h-screen grid-bg" style={{ backgroundColor: 'var(--color-cyber-darker)' }}>
      {/* Header */}
      <div className="glass-panel neon-border" style={{ borderRadius: 0 }}>
        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
          <h1 className="text-2xl neon-text" style={{ fontFamily: 'var(--font-cyber)' }}>
            PLAYER TERMINAL
          </h1>
          <div className="flex items-center gap-4">
            <span className="text-sm" style={{ color: 'var(--color-cyber-cyan)', fontFamily: 'var(--font-mono)' }}>
              {profile?.username || 'PLAYER'}
            </span>
            <button onClick={handleSignOut} className="neon-button-magenta text-sm">
              LOGOUT
            </button>
          </div>
        </div>
      </div>

      <div className="container mx-auto px-4 py-8">
        {/* Welcome */}
        <div className="glass-panel neon-border p-6 mb-6">
          <h2 className="text-xl mb-2" style={{ fontFamily: 'var(--font-cyber)', color: 'var(--color-cyber-cyan)' }}>
            WELCOME, {profile?.username?.toUpperCase()}
          </h2>
          <p className="text-sm" style={{ color: 'var(--color-cyber-cyan)', opacity: 0.7, fontFamily: 'var(--font-mono)' }}>
            Access Level: PLAYER // Status: ONLINE
          </p>
        </div>

        {/* Character Selection (if multiple) */}
        {characters.length > 1 && (
          <div className="glass-panel p-4 mb-6" style={{ border: '1px solid color-mix(in srgb, var(--color-cyber-cyan) 30%, transparent)' }}>
            <label className="block text-sm mb-2" style={{ color: 'var(--color-cyber-cyan)', fontFamily: 'var(--font-mono)' }}>
              SELECT CHARACTER
            </label>
            <select
              value={selectedCharacter?.id || ''}
              onChange={(e) => {
                const char = characters.find(c => c.id === e.target.value);
                setSelectedCharacter(char || null);
              }}
              className="terminal-input w-full"
            >
              {characters.map(char => (
                <option key={char.id} value={char.id}>
                  {char.name} - Level {char.level} {getClassInfo(char.class)?.name}
                </option>
              ))}
            </select>
          </div>
        )}

        {loading ? (
          <div className="glass-panel p-8 text-center">
            <div className="animate-spin w-12 h-12 border-4 rounded-full mx-auto mb-4" 
                 style={{ 
                   borderColor: 'color-mix(in srgb, var(--color-cyber-cyan) 30%, transparent)',
                   borderTopColor: 'var(--color-cyber-cyan)'
                 }}>
            </div>
            <p style={{ color: 'var(--color-cyber-cyan)', fontFamily: 'var(--font-mono)' }}>
              Loading character data...
            </p>
          </div>
        ) : error ? (
          <div className="glass-panel p-6" style={{ border: '1px solid var(--color-cyber-pink)' }}>
            <p style={{ color: 'var(--color-cyber-pink)', fontFamily: 'var(--font-mono)' }}>
              Error: {error}
            </p>
          </div>
        ) : !selectedCharacter ? (
          // No Character State
          <div className="glass-panel p-12 text-center">
            <h3 className="text-2xl mb-4" style={{ fontFamily: 'var(--font-cyber)', color: 'var(--color-cyber-cyan)' }}>
              NO CHARACTER FOUND
            </h3>
            <p className="mb-6" style={{ color: 'var(--color-cyber-cyan)', opacity: 0.7, fontFamily: 'var(--font-mono)' }}>
              Create your first character to begin your cyberpunk adventure
            </p>
            <button
              onClick={() => navigate('/character/create')}
              className="neon-button"
              style={{ fontFamily: 'var(--font-cyber)' }}
            >
              CREATE CHARACTER
            </button>
          </div>
        ) : (
          // Character Dashboard
          <>
            {/* Main Grid */}
            <div className="grid lg:grid-cols-3 gap-6 mb-6">
              {/* Character Stats */}
              <div className="glass-panel p-6" style={{ border: '1px solid color-mix(in srgb, var(--color-cyber-cyan) 30%, transparent)' }}>
                <h3 className="text-lg mb-4 flex items-center justify-between" style={{ fontFamily: 'var(--font-cyber)', color: 'var(--color-cyber-cyan)' }}>
                  <span className="flex items-center">
                    <span className="w-2 h-2 rounded-full mr-3 animate-pulse" style={{ backgroundColor: 'var(--color-cyber-green)' }}></span>
                    {selectedCharacter.name.toUpperCase()}
                  </span>
                </h3>
                
                <div className="mb-4">
                  <div className="text-sm mb-1" style={{ color: 'var(--color-cyber-cyan)', opacity: 0.7, fontFamily: 'var(--font-mono)' }}>
                    Level {selectedCharacter.level} {getClassInfo(selectedCharacter.class)?.name}
                  </div>
                </div>

                {/* HP Bar */}
                <div className="mb-4">
                  <div className="flex justify-between text-sm mb-1" style={{ fontFamily: 'var(--font-mono)' }}>
                    <span style={{ color: 'var(--color-cyber-pink)' }}>HP</span>
                    <span style={{ color: 'var(--color-cyber-cyan)' }}>
                      {selectedCharacter.current_hp} / {selectedCharacter.max_hp}
                    </span>
                  </div>
                  <div className="h-2 rounded" style={{ backgroundColor: 'color-mix(in srgb, var(--color-cyber-pink) 20%, transparent)' }}>
                    <div
                      className="h-full rounded transition-all"
                      style={{
                        width: `${(selectedCharacter.current_hp / selectedCharacter.max_hp) * 100}%`,
                        backgroundColor: 'var(--color-cyber-pink)'
                      }}
                    ></div>
                  </div>
                </div>

                {/* Core Stats */}
                <div className="grid grid-cols-2 gap-2 text-xs mb-4" style={{ fontFamily: 'var(--font-mono)' }}>
                  <div className="flex justify-between">
                    <span style={{ color: 'var(--color-cyber-cyan)', opacity: 0.7 }}>AC:</span>
                    <span style={{ color: 'var(--color-cyber-green)' }}>{selectedCharacter.ac}</span>
                  </div>
                  <div className="flex justify-between">
                    <span style={{ color: 'var(--color-cyber-cyan)', opacity: 0.7 }}>CDD:</span>
                    <span style={{ color: 'var(--color-cyber-green)' }}>{selectedCharacter.cdd}</span>
                  </div>
                </div>

                {/* Ability Scores */}
                <div className="grid grid-cols-3 gap-2 text-center">
                  {[
                    { name: 'STR', value: selectedCharacter.str },
                    { name: 'DEX', value: selectedCharacter.dex },
                    { name: 'CON', value: selectedCharacter.con },
                    { name: 'WIS', value: selectedCharacter.wis },
                    { name: 'INT', value: selectedCharacter.int },
                    { name: 'CHA', value: selectedCharacter.cha }
                  ].map(stat => (
                    <div key={stat.name} className="p-2 rounded" style={{ border: '1px solid color-mix(in srgb, var(--color-cyber-cyan) 20%, transparent)' }}>
                      <div className="text-xs" style={{ color: 'var(--color-cyber-cyan)', opacity: 0.7, fontFamily: 'var(--font-mono)' }}>
                        {stat.name}
                      </div>
                      <div className="text-lg" style={{ color: 'var(--color-cyber-cyan)', fontFamily: 'var(--font-mono)' }}>
                        {stat.value}
                      </div>
                      <div className="text-xs" style={{ color: 'var(--color-cyber-green)', fontFamily: 'var(--font-mono)' }}>
                        {formatModifier(calculateStatModifier(stat.value))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Currency & Actions */}
              <div className="space-y-6">
                {/* USD */}
                <div className="glass-panel p-6" style={{ border: '1px solid color-mix(in srgb, var(--color-cyber-green) 30%, transparent)' }}>
                  <h3 className="text-lg mb-4" style={{ fontFamily: 'var(--font-cyber)', color: 'var(--color-cyber-green)' }}>
                    CREDITS
                  </h3>
                  <div className="text-3xl" style={{ color: 'var(--color-cyber-green)', fontFamily: 'var(--font-mono)' }}>
                    ${selectedCharacter.usd.toLocaleString()}
                  </div>
                  <div className="text-xs mt-1" style={{ color: 'var(--color-cyber-cyan)', opacity: 0.5, fontFamily: 'var(--font-mono)' }}>
                    USD
                  </div>
                </div>

                {/* Quick Actions */}
                <div className="glass-panel p-6" style={{ border: '1px solid color-mix(in srgb, var(--color-cyber-magenta) 30%, transparent)' }}>
                  <h3 className="text-lg mb-4" style={{ fontFamily: 'var(--font-cyber)', color: 'var(--color-cyber-magenta)' }}>
                    QUICK ACCESS
                  </h3>
                  <div className="space-y-3">
                    <button 
                      onClick={() => navigate(`/character/${selectedCharacter.id}`)}
                      className="neon-button w-full text-left text-sm"
                    >
                      üìã FULL CHARACTER SHEET
                    </button>
                    <button 
                      onClick={() => navigate(`/character/${selectedCharacter.id}/inventory`)}
                      className="neon-button w-full text-left text-sm"
                    >
                      üì¶ INVENTORY
                    </button>
                    <button 
                      onClick={() => navigate(`/character/${selectedCharacter.id}/abilities`)}
                      className="neon-button w-full text-left text-sm"
                    >
                      ‚ö° ABILITIES
                    </button>
                    <button 
                      onClick={() => navigate('/map')}
                      className="neon-button w-full text-left text-sm"
                    >
                      üó∫Ô∏è WORLD MAP
                    </button>
                    <button 
                      onClick={() => navigate('/missions')}
                      className="neon-button w-full text-left text-sm"
                    >
                      ÔøΩ MISSIONS
                    </button>
                  </div>
                </div>
              </div>

              {/* Class Info */}
              <div className="glass-panel p-6" style={{ border: '1px solid color-mix(in srgb, var(--color-cyber-purple) 30%, transparent)' }}>
                <h3 className="text-lg mb-4" style={{ fontFamily: 'var(--font-cyber)', color: 'var(--color-cyber-purple)' }}>
                  CLASS FEATURES
                </h3>
                
                <div className="space-y-3">
                  {selectedCharacter.class_features && selectedCharacter.class_features.length > 0 ? (
                    selectedCharacter.class_features.map((feature: any, idx: number) => (
                      <div
                        key={idx}
                        className="p-3 rounded"
                        style={{ border: '1px solid color-mix(in srgb, var(--color-cyber-purple) 30%, transparent)' }}
                      >
                        <div className="flex justify-between items-center mb-1">
                          <span className="text-sm" style={{ color: 'var(--color-cyber-purple)', fontFamily: 'var(--font-cyber)' }}>
                            {feature.name}
                          </span>
                          {feature.charges && (
                            <span
                              className="text-xs px-2 py-1 rounded"
                              style={{ backgroundColor: 'var(--color-cyber-purple)', color: 'var(--color-cyber-darker)' }}
                            >
                              {feature.charges} ‚ö°
                            </span>
                          )}
                        </div>
                        <p className="text-xs" style={{ color: 'var(--color-cyber-cyan)', opacity: 0.7, fontFamily: 'var(--font-mono)' }}>
                          {feature.description}
                        </p>
                      </div>
                    ))
                  ) : (
                    <p className="text-sm" style={{ color: 'var(--color-cyber-cyan)', opacity: 0.5, fontFamily: 'var(--font-mono)' }}>
                      No class features yet
                    </p>
                  )}
                </div>

                <div className="mt-4 pt-4" style={{ borderTop: '1px solid color-mix(in srgb, var(--color-cyber-purple) 20%, transparent)' }}>
                  <div className="text-xs mb-2" style={{ color: 'var(--color-cyber-purple)', fontFamily: 'var(--font-mono)' }}>
                    TOOLS
                  </div>
                  <div className="space-y-1">
                    {selectedCharacter.tools && selectedCharacter.tools.length > 0 ? (
                      selectedCharacter.tools.map((tool, idx) => (
                        <div key={idx} className="text-xs" style={{ color: 'var(--color-cyber-cyan)', opacity: 0.7, fontFamily: 'var(--font-mono)' }}>
                          ‚Ä¢ {tool}
                        </div>
                      ))
                    ) : (
                      <div className="text-xs" style={{ color: 'var(--color-cyber-cyan)', opacity: 0.5, fontFamily: 'var(--font-mono)' }}>
                        No tools equipped
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* Coming Soon Features */}
            <div className="glass-panel p-6" style={{ border: '1px solid color-mix(in srgb, var(--color-cyber-cyan) 30%, transparent)' }}>
              <h3 className="text-lg mb-4" style={{ fontFamily: 'var(--font-cyber)', color: 'var(--color-cyber-cyan)' }}>
                COMING SOON
              </h3>
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <h4 className="text-sm mb-2" style={{ color: 'var(--color-cyber-magenta)', fontFamily: 'var(--font-mono)' }}>
                    üéÆ 3D Character Viewer
                  </h4>
                  <p className="text-xs" style={{ color: 'var(--color-cyber-cyan)', opacity: 0.5, fontFamily: 'var(--font-mono)' }}>
                    View your character's 3D model with orbit controls
                  </p>
                </div>
                <div>
                  <h4 className="text-sm mb-2" style={{ color: 'var(--color-cyber-magenta)', fontFamily: 'var(--font-mono)' }}>
                    üé≤ 3D Battle Map
                  </h4>
                  <p className="text-xs" style={{ color: 'var(--color-cyber-cyan)', opacity: 0.5, fontFamily: 'var(--font-mono)' }}>
                    Tactical combat grid with your character model
                  </p>
                </div>
              </div>
            </div>
          </>
        )}
      </div>
    </div>
  );
}
